package contracts

import (
	"strings"

	"github.com/ethereum/go-ethereum/accounts/abi"
	"github.com/ethereum/go-ethereum/accounts/abi/bind"
	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/core/types"
)

// DeployZKRollupSafe deploys a new ZKRollup contract safely
func DeployZKRollupSafe(auth *bind.TransactOpts, backend bind.ContractBackend) (common.Address, *types.Transaction, error) {
	// The bytecode is the compiled Solidity contract
	bytecode := common.FromHex("608060405234801561001057600080fd5b5061057f806100206000396000f3fe608060405234801561001057600080fd5b506004361061004c5760003560e01c80635e8a791d146100515780638f1d3776146100815780639fa6a6e3146100a1578063c5b1d9aa146100bf575b600080fd5b61006b60048036038101906100669190610341565b6100dd565b60405161007891906103a3565b60405180910390f35b61009b600480360381019061009691906103be565b610132565b005b6100a9610261565b6040516100b6919061046a565b60405180910390f35b6100d960048036038101906100d49190610341565b610267565b005b60006001600083815260200190815260200160002060010160009054906101000a900460ff169050919050565b6000805490506000811161017a576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161017190610502565b60405180910390fd5b60008111801561018c5750600081115b6101cb576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016101c290610502565b60405180910390fd5b60006001600085815260200190815260200160002060010160009054906101000a900460ff1690506101fd85858585610267565b7f5a978f4f6ea5d4a5a575f1e07f74f7e89a1367e9e09d3f7e9c93237c10c2d46b8583604051610230929190610522565b60405180910390a1505050505050565b60005481565b6040518060600160405280838152602001600115158152602001428152506001600085815260200190815260200160002060008201518160000155602082015181600101600a81111561028f577f4e487b7100000000000000000000000000000000000000000000000000000000600052602160045260246000fd5b60ff1660ff16815260200160408201518160020155905050600160008082825461029a9190610551565b925050819055507f33a88a5e8eeccf39bfcf2b75e76a0b0f9abcc94f3b43d8af1da4d11b773e042c848360405161030c9291906105a7565b60405180910390a150505050565b600081359050610328816105d6565b92915050565b60008135905061033d816105ed565b92915050565b60006020828403121561035357600080fd5b600061036184828501610319565b91505092915050565b61037381610485565b82525050565b61038281610497565b82525050565b61039d61039882610497565b6104d2565b82525050565b60006020820190506103b8600083018461036a565b92915050565b600080600080608085870312156103d457600080fd5b60006103e287828801610319565b94505060206103f38782880161032e565b935050604085013567ffffffffffffffff81111561041057600080fd5b61041c87828801610319565b925050606085013567ffffffffffffffff81111561043957600080fd5b61044587828801610319565b91505092959194509250565b61045a816104a3565b82525050565b610469816104ad565b82525050565b60006020820190506104846000830184610460565b92915050565b60006104908261049d565b9050919050565b60008115159050919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000819050919050565b60006104b8826104bf565b9050919050565b60006104ca826104d2565b9050919050565b6000819050919050565b600082825260208201905092915050565b7f496e76616c69642062617463682073746174650000000000000000000000000060008201525060140190565b600060408201905061051c6000830185610460565b6105296020830184610460565b9392505050565b600061053c8261049d565b91506105478361049d565b9250827fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0382111561057c5761057b6105a7565b5b828201905092915050565b600060408201905061059c6000830185610460565b6105a96020830184610379565b9392505050565b60006040820190506105c56000830185610460565b6105d26020830184610460565b9392505050565b6105df816104a3565b81146105ea57600080fd5b50565b6105f6816104ad565b811461060157600080fd5b5056fea26469706673582212204a3c1a2a0e4c4b3e0e711d2eb54a3bd3f5d5d7e5e9e01c0b1b8bef6a4a16c2b364736f6c63430008070033")

	// Parse the ABI
	parsed, err := abi.JSON(strings.NewReader(ZKRollupABI))
	if err != nil {
		return common.Address{}, nil, err
	}

	// Deploy the contract
	address, tx, _, err := bind.DeployContract(auth, parsed, bytecode, backend)
	if err != nil {
		return common.Address{}, nil, err
	}

	return address, tx, nil
}
